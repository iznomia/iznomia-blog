---
wiki: oi-note
title: 线段树
katex: true
references:
    - https://www.luogu.com.cn/blog/George-Plover/qian-tan-xian-xing-lan-biao-ji-wei-hu-ji-qiao-yi-xian-duan-shu-wei-li
updated: 2025-12-04
---

线段树是一种功能强大的二叉数据结构，可以维护**半群**上的信息（满足结合律）。

对于一般情况，我们使用**堆式线段树**来存储线段树；对于空间开不下的情况，我们使用**动态开点**来存储线段树。

## 延迟标记

这个东西不只被用在线段树上，但从线段树结构基本可以介绍出它的大部分应用。以下问题都可以直接使用多元标记来处理：

- [区间最大子段和](https://www.luogu.com.cn/problem/P4513)：维护前缀后缀最大子段和、区间和和答案即可；
- [区间平方和](https://www.luogu.com.cn/problem/P1471)：不难根据区间和计算出新的区间平方和；
- [区间加等差数列单点求和](https://www.luogu.com.cn/problem/P1438)：每个点维护一个 $d$，代表其加上的是 $d\times i$，其中 $i$ 是下标，然后再维护一个区间加标记即可。

{% box %}
[\[CF446C\] DZY Loves Fibonacci Numbers](https://www.luogu.com.cn/problem/CF446C).

区间加斐波那契数列，区间求和。
{% endbox %}

将广义斐波那契数列的前两项作为标记打在线段树中，合并时直接加起来就可以。再加上斐波那契数列的求和公式：$\sum_{i=1}^{n}f_i=f_{n+2}-f_{2}$，和便可以直接计算。[代码](https://codeforces.com/contest/446/submission/231721154)。

## 双半群模型

## 例题

### 刷基础 1

#### [2023 钉耙编程 1] Easy problem I

[Portal](https://qoj.ac/contest/1306)。如果一个数发生过 $a_i\leftarrow x-a_i$，那么以后就会一直这样。搞两棵线段树分别维护即可。[代码](https://qoj.ac/submission/1557229)。

#### [Luogu P5278] 算术天才⑨与等差数列

[Portal](https://www.luogu.com.cn/problem/P5278).

发现条件非常严苛，因此可以考虑哈希之类的方法，这里不做赘述。

一段区间可以重排为等差数列，当且仅当满足（$d=0$ 先特判掉）：

- $\max -\min =d\times (len-1)$；
- $\gcd_{i=l}^{r-1}(a_{i+1}-a_i)=d$；
- 序列中没有重复的元素。

用线段树维护即可。第三条可以使用 set、map 维护一个数最左边的出现位置，然后用线段树维护这个值的最小值，如果这个数小于 $l$，那么一定没有重复元素。[代码](https://uoj.ac/submission/653671)。